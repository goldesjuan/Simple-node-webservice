// Generated by CoffeeScript 1.9.2
(function() {
  var addUser, deleteUser, emailUser, populateTable, showUserInfo, smsUser, userListData;

  userListData = [];

  $(document).ready(function() {
    populateTable();
    $('#userList table tbody').on('click', 'td a.linkshowuser', showUserInfo);
    $('#btnAddUser').on('click', addUser);
    $('#userList table tbody').on('click', 'td a.linkdeleteuser', deleteUser);
    $('#userList table tbody').on('click', 'td a.linkemailuser', emailUser);
    return $('#userList table tbody').on('click', 'td a.linksmsuser', smsUser);
  });

  populateTable = function() {
    var tableContent;
    tableContent = '';
    $.getJSON('userlist', function(data) {
      userListData = data;
      $.each(data, function() {
        tableContent += '<tr>';
        tableContent += '<td><a href="#" class="linkshowuser" rel="' + this.username + '">' + this.username + '</a></td>';
        tableContent += '<td><a href="#" class="linkemailuser" rel="' + this.email + '">' + this.email + '</a></td>';
        tableContent += '<td><a href="#" class="linksmsuser" rel="' + this.phone + '">' + (this.phone != null ? this.phone : 'no phone' + '</a></td>');
        tableContent += '<td><a href="#" class="linkdeleteuser" rel="' + this._id + '">delete</a></td>';
        tableContent += '</tr>';
      });
      $('#userList table tbody').html(tableContent);
    });
  };

  showUserInfo = function(event) {
    var arrayPosition, thisUserName, thisUserObject;
    event.preventDefault;
    thisUserName = $(this).attr('rel');
    arrayPosition = userListData.map(function(arrayItem) {
      return arrayItem.username;
    }).indexOf(thisUserName);
    thisUserObject = userListData[arrayPosition];
    $('#userInfoName').text(thisUserObject.fullname);
    $('#userInfoAge').text(thisUserObject.age);
    $('#userInfoGender').text(thisUserObject.gender);
    $('#userInfoLocation').text(thisUserObject.location);
  };

  addUser = function(event) {
    var errorCount, newUser;
    event.preventDefault;
    errorCount = 0;
    $('#addUser input').each(function(index, val) {
      if ($(this).val === '') {
        errorCount++;
      }
    });
    if (errorCount === 0) {
      newUser = {
        'username': $('#addUser fieldset input#inputUserName').val(),
        'email': $('#addUser fieldset input#inputUserEmail').val(),
        'fullname': $('#addUser fieldset input#inputUserFullname').val(),
        'age': $('#addUser fieldset input#inputUserAge').val(),
        'location': $('#addUser fieldset input#inputUserLocation').val(),
        'gender': $('#addUser fieldset input#inputUserGender').val(),
        'phone': $('#addUser fieldset input#inputUserPhone').val()
      };
      $.ajax({
        type: 'POST',
        data: newUser,
        url: '/adduser',
        dataType: 'JSON'
      }).done(function(response) {
        if (response.status === 200) {
          $('#addUser fieldset input').val('');
          return populateTable();
        } else if (typeof error !== "undefined" && error !== null) {
          return alert("Error " + response.error);
        }
      });
    } else {
      alert('Please fill in all fields');
      return false;
    }
  };

  deleteUser = function(event) {
    var confirmation;
    event.preventDefault;
    confirmation = confirm('Are you sure you want to delete this user?');
    if (confirmation) {
      $.ajax({
        type: 'DELETE',
        url: "/deleteuser/" + ($(this).attr('rel')),
        success: function(response) {
          return populateTable();
        },
        error: function(error) {
          return alert("error " + error);
        }
      });
    } else {
      return false;
    }
  };

  emailUser = function(event) {
    var confirmation, emailData, userEmail;
    event.preventDefault;
    userEmail = $(this).attr('rel');
    confirmation = confirm('Send email to ' + userEmail + '?');
    emailData = {
      'from': 'Notifications <youremail@yourdomain.com>',
      'to': userEmail,
      'subject': 'Sent from web',
      'text': 'This email has been sent using a Node webservice and Mailgun',
      'v:custom_id': Date.now()
    };
    if (confirmation) {
      $.ajax({
        type: 'POST',
        data: emailData,
        url: '/postemail',
        dataType: 'JSON'
      }).done(function(response) {
        if (response.status === 200) {
          return alert('Email sent');
        } else {
          return alert('Error sending email');
        }
      });
    } else {
      return false;
    }
  };

  smsUser = function(event) {
    var message, smsData, userPhone;
    event.preventDefault;
    userPhone = $(this).attr('rel');
    if (userPhone != null) {
      message = prompt('Please enter your message for ' + userPhone);
      smsData = {
        'sms': {
          'from': '+12055066728',
          'to': userPhone,
          'body': message
        },
        'custom_id': Date.now()
      };
      $.ajax({
        type: 'POST',
        data: smsData,
        url: '/postsms',
        dataType: 'JSON'
      }).done(function(response) {
        if (response.status === 200) {
          return alert('Message sent');
        } else {
          return 'Error sending message';
        }
      });
    } else {
      alert('No phone number specified');
      return false;
    }
  };

}).call(this);
